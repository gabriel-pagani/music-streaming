DROP TABLE IF EXISTS EMPRESTIMOS;
DROP TABLE IF EXISTS SOLICITACOES;
DROP TABLE IF EXISTS USUARIOS;

CREATE TABLE USUARIOS (
    	ID INT IDENTITY(1,1) PRIMARY KEY, 	
	EMAIL VARCHAR(255) UNIQUE CHECK (EMAIL LIKE '%_@_%._%') NOT NULL,
	HASH_SENHA VARCHAR(255) NOT NULL,
	NOME VARCHAR(255),
	CPF CHAR(14) CHECK (CPF LIKE '___.___.___-__'),
    	DATA_NASCIMENTO DATE,
    	RENDA_MENSAL DECIMAL(10,2),    
	ESTADO CHAR(2),
   	CIDADE VARCHAR(255),
    	BAIRRO VARCHAR(255),
	ENDERECO VARCHAR(255),
	NUMERO INT,
    	CEP CHAR(9) CHECK (cep LIKE '_____-___'),
	REFERENCIA VARCHAR(255),
    	STATUS VARCHAR(9) CHECK (STATUS IN ('Ativo', 'Inativo', 'Bloqueado')) DEFAULT 'Inativo',
	TIPO VARCHAR(8) CHECK (TIPO IN ('Admin', 'User', 'Approver')) DEFAULT 'User',
	SCORE INT CHECK (SCORE BETWEEN -1000 and 1000) DEFAULT 0, 
	DATA_CADASTRO DATE DEFAULT GETDATE(),
    	OBSERVACOES VARCHAR(MAX),
);
CREATE UNIQUE INDEX CPF_USUARIOS ON USUARIOS(CPF) WHERE CPF IS NOT NULL;

CREATE TABLE SOLICITACOES (
    	ID INT IDENTITY(1,1) PRIMARY KEY, 	
	ID_SOLICITANTE INT FOREIGN KEY REFERENCES USUARIOS(ID) NOT NULL,
	ID_PROVADOR INT FOREIGN KEY REFERENCES USUARIOS(ID),
	VALOR_INDICADO DECIMAL(10,2),
	VALOR_SOLICITADO DECIMAL(10,2) NOT NULL,
	DATA_EMPRESTIMO DATE NOT NULL,
	NUMERO_MESES INT CHECK (SCORE BETWEEN 1 and 6) NOT NULL,
    	EXPLICACAO VARCHAR(MAX) NOT NULL,
	STATUS VARCHAR(10) CHECK (STATUS IN ('Em análise', 'Aprovado', 'Reprovado')) DEFAULT 'Em análise',
	DATA_SOLICITACAO DATE DEFAULT GETDATE(),    
	OBSERVACOES VARCHAR(MAX), 	

	CONSTRAINT CHK_DATAS CHECK (
		DATA_EMPRESTIMO > CAST(DATEADD(DAY, 15, GETDATE()) AS DATE)
	)
);

CREATE TABLE EMPRESTIMOS (
    	ID INT IDENTITY(1,1) PRIMARY KEY, 
	ID_USUARIO INT FOREIGN KEY REFERENCES USUARIOS(ID) NOT NULL,
	ID_SOLICITACAO INT FOREIGN KEY REFERENCES SOLICITACOES(ID) NOT NULL,
	VALOR DECIMAL(10,2),
	JUROS_MENSAL DECIMAL(5,2),
	DATA_EMPRESTIMO DATE NOT NULL,
	DATA_VENCIMENTO DATE NOT NULL,
    	EXPLICACAO VARCHAR(MAX) NOT NULL, 
	STATUS VARCHAR(12) CHECK (STATUS IN ('Em andamento', 'Quitado', 'Atrasado')) DEFAULT 'Em andamento', 
	OBSERVACOES VARCHAR(MAX), 	
);
